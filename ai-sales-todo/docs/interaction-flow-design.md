# AI商談支援アプリ - インタラクションフロー設計書

## 1. 全体フロー概要

### 1.1 メインユーザージャーニー
```
[ログイン] → [商談準備開始] → [BANTヒアリング] → [ToDo生成] → [商談実行] → [完了・保存]
    ↓              ↓              ↓              ↓            ↓
認証フロー    初期設定フロー   チャットフロー   編集フロー   音声解析フロー
```

### 1.2 システム状態遷移
```
初期状態 (Initial)
    ↓
認証完了 (Authenticated) 
    ↓
商談準備 (Preparation)
    ↓
BANT実行 (BANTInProgress) 
    ↓
ToDo生成 (TodoGeneration)
    ↓
商談実行 (MeetingInProgress)
    ↓
完了状態 (Completed)
```

## 2. 詳細インタラクションフロー

### 2.1 認証・ログインフロー

#### 2.1.1 初回訪問時
```mermaid
graph TD
    A[アプリアクセス] --> B{ユーザー認証?}
    B -->|未認証| C[ログインページ表示]
    B -->|認証済み| D[メインページ表示]
    
    C --> E[認証情報入力]
    E --> F[Supabase認証]
    F --> G{認証成功?}
    G -->|成功| H[リダイレクト処理]
    G -->|失敗| I[エラー表示]
    
    I --> E
    H --> D
    
    D --> J[ウェルカムメッセージ]
    J --> K[商談準備開始ボタン]
```

#### 2.1.2 ユーザーアクション
- **入力フィールド**: メールアドレス、パスワード
- **フィードバック**: 入力検証（リアルタイム）、ローディング状態
- **エラーハンドリング**: 無効な認証情報、ネットワークエラー
- **成功時動作**: スムーズなページ遷移、状態復元

### 2.2 BANTヒアリングフロー

#### 2.2.1 チャット初期化
```mermaid
graph TD
    A[商談準備開始] --> B[ChatInterface初期化]
    B --> C[AIウェルカムメッセージ]
    C --> D[Budget段階開始]
    
    D --> E[進捗バー表示: 0/4]
    E --> F[現在の段階インジケーター]
    F --> G[予算に関する初回質問]
```

#### 2.2.2 段階別インタラクション

**Budget段階のフロー:**
```mermaid
graph TD
    A[Budget質問表示] --> B[ユーザー回答入力]
    B --> C[送信ボタンクリック]
    C --> D[入力検証]
    D --> E{有効な入力?}
    
    E -->|無効| F[エラー表示]
    F --> B
    
    E -->|有効| G[送信処理開始]
    G --> H[ローディング表示]
    H --> I[Gemini API呼び出し]
    I --> J[AI応答生成]
    J --> K[追加質問 or 次段階]
    
    K --> L{Budget完了?}
    L -->|未完了| M[追加質問表示]
    M --> B
    L -->|完了| N[Authority段階開始]
```

#### 2.2.3 段階間遷移
- **視覚的フィードバック**: 進捗サークルの色変更（グレー→ブルー→グリーン）
- **アニメーション**: スムーズなトランジション（0.3秒）
- **状態保存**: 各段階の回答データ永続化
- **戻り機能**: 前の段階への戻り（編集可能）

### 2.3 ToDo生成・編集フロー

#### 2.3.1 自動生成プロセス
```mermaid
graph TD
    A[BANT完了] --> B[ToDo生成開始]
    B --> C[ローディング表示]
    C --> D["「生成中...」アニメーション"]
    
    D --> E[Gemini API呼び出し]
    E --> F[回答データ分析]
    F --> G[カスタマイズToDo作成]
    
    G --> H{生成成功?}
    H -->|失敗| I[フォールバック実行]
    H -->|成功| J[ToDo一覧表示]
    
    I --> K[デフォルトToDo表示]
    K --> J
    
    J --> L[編集機能有効化]
    L --> M[商談開始ボタン表示]
```

#### 2.3.2 ToDoアイテム操作
```mermaid
graph TD
    A[ToDoアイテム] --> B{ユーザーアクション}
    
    B -->|完了チェック| C[チェック状態切り替え]
    C --> D[視覚的フィードバック]
    D --> E[進捗率再計算]
    
    B -->|編集クリック| F[インライン編集モード]
    F --> G[テキスト入力フィールド]
    G --> H[保存/キャンセルボタン]
    
    B -->|削除クリック| I[確認ダイアログ]
    I --> J{削除確認?}
    J -->|はい| K[アイテム削除]
    J -->|いいえ| A
    
    B -->|追加ボタン| L[新規アイテム入力]
    L --> M[カテゴリ選択]
    M --> N[追加実行]
```

#### 2.3.3 視覚的フィードバック
- **完了状態**: グリーンハイライト + チェックアイコン
- **編集状態**: フォーカスアウトライン + 編集コントロール
- **ホバー効果**: 微細な影・スケール変化
- **進捗更新**: プログレスバーのスムーズなアニメーション

### 2.4 音声解析・商談実行フロー

#### 2.4.1 商談開始プロセス
```mermaid
graph TD
    A[商談開始ボタン] --> B[マイクアクセス要求]
    B --> C{アクセス許可?}
    
    C -->|拒否| D[エラーメッセージ]
    D --> E[手動モード提案]
    
    C -->|許可| F[音声初期化]
    F --> G[録音待機状態]
    G --> H[録音ボタン表示]
    
    H --> I[ユーザークリック]
    I --> J[録音開始]
    J --> K[視覚的録音インジケーター]
```

#### 2.4.2 リアルタイム音声処理
```mermaid
graph TD
    A[音声入力] --> B[Web Speech API]
    B --> C[テキスト変換]
    C --> D[30秒バッファリング]
    
    D --> E[バッファ送信]
    E --> F[Gemini類似度計算]
    F --> G{閾値以上?}
    
    G -->|はい| H[ToDo自動完了]
    G -->|いいえ| I[継続監視]
    
    H --> J[完了アニメーション]
    J --> K[音声フィードバック]
    K --> L[進捗更新]
    
    L --> M{全タスク完了?}
    M -->|はい| N[商談完了処理]
    M -->|いいえ| I
```

#### 2.4.3 音声制御インタラクション
- **録音開始**: 大きな録音ボタン（緑→赤）、パルスアニメーション
- **録音中**: 時間表示、音声波形（オプション）、停止ボタン
- **処理中**: スピナー + 「解析中...」テキスト
- **完了検知**: 成功アニメーション + 音声通知

### 2.5 エラーハンドリングフロー

#### 2.5.1 API障害対応
```mermaid
graph TD
    A[API呼び出し] --> B[タイムアウト監視]
    B --> C{応答あり?}
    
    C -->|タイムアウト| D[リトライ処理]
    D --> E{リトライ3回?}
    E -->|未満| A
    E -->|上限| F[フォールバック実行]
    
    C -->|エラー応答| G[エラー分類]
    G --> H{エラー種別}
    H -->|認証| I[再ログイン促し]
    H -->|API制限| J[一時的制限通知]
    H -->|その他| F
    
    F --> K[ローカル機能提供]
    K --> L[制限事項説明]
```

#### 2.5.2 ユーザー体験保持
- **グレースフルデグラデーション**: 核心機能は維持
- **明確なエラーメッセージ**: 原因と対処法を説明
- **代替手段提供**: 手動操作による継続
- **状態復元**: エラー解決後の自動復帰

### 2.6 設定・カスタマイゼーションフロー

#### 2.6.1 音声設定調整
```mermaid
graph TD
    A[設定ボタン] --> B[設定パネル展開]
    B --> C[現在値表示]
    
    C --> D{設定変更}
    D -->|類似度閾値| E[スライダー操作]
    D -->|言語設定| F[ドロップダウン選択]
    D -->|音量調整| G[ボリューム調整]
    
    E --> H[リアルタイム適用]
    F --> I[音声エンジン再初期化]
    G --> J[テスト音声再生]
    
    H --> K[設定保存]
    I --> K
    J --> K
    K --> L[保存確認フィードバック]
```

#### 2.6.2 インタラクティブ調整
- **即座の反映**: 設定変更の即時適用
- **プレビュー機能**: 変更結果の事前確認
- **リセット機能**: デフォルト値への復元
- **設定説明**: ツールチップによるヘルプ

### 2.7 データ保存・復元フロー

#### 2.7.1 自動保存プロセス
```mermaid
graph TD
    A[ユーザー操作] --> B[状態変更検知]
    B --> C[デバウンス処理]
    C --> D[保存データ準備]
    
    D --> E[Supabaseへ送信]
    E --> F{保存成功?}
    
    F -->|成功| G[保存インジケーター]
    F -->|失敗| H[ローカル保存]
    
    H --> I[同期キュー追加]
    I --> J[接続復旧時同期]
    
    G --> K[ユーザーフィードバック]
    J --> K
```

#### 2.7.2 セッション管理
- **自動保存**: 操作から2秒後に自動実行
- **オフライン対応**: ローカルストレージにバックアップ
- **同期機能**: オンライン復帰時の自動同期
- **履歴管理**: 商談セッション履歴の保存

## 3. レスポンシブインタラクション

### 3.1 デバイス別最適化

#### 3.1.1 モバイル（スマートフォン）
- **タッチ操作**: 44px以上のタッチターゲット
- **スワイプ**: 段階間のスワイプナビゲーション
- **音声入力**: 大きな音声ボタン、長押し録音
- **画面遷移**: フルスクリーンモーダル使用

#### 3.1.2 タブレット
- **ハイブリッド操作**: タッチ + 一部マウス操作
- **分割画面**: チャットとToDo同時表示
- **ドラッグ&ドロップ**: ToDo並び替え機能
- **ピンチズーム**: ダッシュボード拡大縮小

#### 3.1.3 デスクトップ
- **キーボードショートカット**: Ctrl+S（保存）、Enter（送信）
- **ホバー効果**: リッチなマウスオーバーフィードバック
- **複数ウィンドウ**: サブウィンドウでの詳細表示
- **右クリックメニュー**: コンテキストメニュー

### 3.2 アクセシビリティインタラクション

#### 3.2.1 キーボード操作
```mermaid
graph TD
    A[Tab] --> B[次要素フォーカス]
    B --> C[視覚的フォーカス表示]
    
    D[Shift+Tab] --> E[前要素フォーカス]
    
    F[Enter/Space] --> G[アクション実行]
    G --> H[実行フィードバック]
    
    I[Escape] --> J[モーダル/メニュー閉じる]
    
    K[Arrow Keys] --> L[リスト内移動]
```

#### 3.2.2 スクリーンリーダー対応
- **ARIA属性**: role, aria-label, aria-describedby
- **構造化マークアップ**: 見出し階層、ランドマーク
- **動的コンテンツ通知**: aria-live regions
- **フォーカス管理**: 論理的なフォーカス順序

## 4. パフォーマンス最適化

### 4.1 レンダリング最適化
- **仮想化**: 長いToDoリストの仮想スクロール
- **遅延読み込み**: 画面外コンポーネントの遅延マウント
- **メモ化**: React.memo による再レンダリング抑制
- **バンドル分割**: ルート別コード分割

### 4.2 インタラクション応答性
- **デバウンス**: 連続操作の制限（300ms）
- **スロットリング**: 音声処理の頻度制限
- **プリロード**: 次画面リソースの先読み
- **キャッシュ**: API応答のクライアントキャッシュ

## 5. 状態管理パターン

### 5.1 クライアント状態
```javascript
// 状態管理構造
const AppState = {
  // 認証状態
  auth: {
    user: null,
    loading: false,
    error: null
  },
  
  // 商談フロー状態
  meeting: {
    currentStep: 'chat', // 'chat' | 'todo' | 'meeting'
    projectId: null,
    bantAnswers: {},
    todos: [],
    progress: 0
  },
  
  // 音声機能状態
  audio: {
    isRecording: false,
    transcript: '',
    isProcessing: false,
    settings: {
      language: 'ja-JP',
      threshold: 0.7,
      volume: 1.0
    }
  },
  
  // UI状態
  ui: {
    sidebarOpen: false,
    settingsOpen: false,
    loading: {},
    errors: {}
  }
}
```

### 5.2 状態更新パターン
```javascript
// Reducer パターン例
function meetingReducer(state, action) {
  switch (action.type) {
    case 'CHAT_COMPLETE':
      return {
        ...state,
        currentStep: 'todo',
        bantAnswers: action.payload.answers,
        projectId: action.payload.projectId
      }
      
    case 'TODO_UPDATE':
      return {
        ...state,
        todos: state.todos.map(todo =>
          todo.id === action.payload.id
            ? { ...todo, ...action.payload.updates }
            : todo
        )
      }
      
    case 'AUDIO_START':
      return {
        ...state,
        audio: {
          ...state.audio,
          isRecording: true,
          transcript: ''
        }
      }
      
    default:
      return state
  }
}
```

---

**文書作成日**: 2025年1月8日  
**作成者**: Worker1  
**承認者**: Boss1, President  
**バージョン**: 1.0